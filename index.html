<!DOCTYPE html>
<html lang="en">
<head>
    <!-- Google Analytics -->
    <script async src="https://www.googletagmanager.com/gtag/js?id=G-RBDE1VBYBN"></script>
    <script>
        window.dataLayer = window.dataLayer || [];
        function gtag(){dataLayer.push(arguments);}
        gtag('js', new Date());
        gtag('config', 'G-RBDE1VBYBN');
    </script>
    <!-- End Google Analytics -->
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <title>Gio Ninja: Φτιάξαμε το απόλυτο legendary game type shii</title>

    <!-- Open Graph / Facebook -->
    <meta property="og:type" content="website">
    <meta property="og:url" content="https://luben.tv/gioninja/">
    <meta property="og:title" content="Gio Ninja: Φτιάξαμε το απόλυτο legendary game type shii">
    <meta property="og:description" content="ΝΟΟΤΡΟΠΙΑ PLAY THE GAME">
    <meta property="og:image" content="https://luben.tv/gioninja/assets/fb.jpg">

    <!-- Twitter -->
    <meta name="twitter:card" content="summary_large_image">
    <meta name="twitter:title" content="Gio Ninja: Φτιάξαμε το απόλυτο legendary game type shii">
    <meta name="twitter:description" content="ΝΟΟΤΡΟΠΙΑ PLAY THE GAME">
    <meta name="twitter:image" content="https://luben.tv/gioninja/assets/fb.jpg">

    <meta name="description" content="ΝΟΟΤΡΟΠΙΑ PLAY THE GAME">
    <script src="https://cdn.jsdelivr.net/npm/phaser@3.60.0/dist/phaser-arcade-physics.min.js"></script>
    <!-- Firebase -->
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-database-compat.js"></script>
    <script>
        const firebaseConfig = {
            apiKey: "AIzaSyCIAJRwtFXQkWG-vv3Ou5vtQXPqDhZ7HkM",
            authDomain: "gioninja.firebaseapp.com",
            databaseURL: "https://gioninja-default-rtdb.europe-west1.firebasedatabase.app",
            projectId: "gioninja",
            storageBucket: "gioninja.firebasestorage.app",
            messagingSenderId: "363008699795",
            appId: "1:363008699795:web:80f1e5f268179d0f520c66"
        };
        firebase.initializeApp(firebaseConfig);
        const db = firebase.database();
    </script>
    <style>
        :root {
            --gold: #ffcc00;
            --bg-dim: radial-gradient(circle, rgba(0,0,0,0.55) 0%, rgba(0,0,0,0.92) 100%);
            --safe-top: env(safe-area-inset-top);
            --safe-right: env(safe-area-inset-right);
            --safe-bottom: env(safe-area-inset-bottom);
            --safe-left: env(safe-area-inset-left);
        }

        html, body {
            margin: 0; padding: 0; width: 100%; height: 100%;
            background-color: #000; overflow: hidden;
            font-family: 'Arial', sans-serif; user-select: none;
            -webkit-user-select: none; touch-action: none;
        }

        canvas { display: block; }
        
        #ui-layer, #lose-screen {
            position: absolute; top: 0; left: 0; width: 100%; height: 100%;
            display: flex; flex-direction: column; align-items: center; justify-content: center;
            z-index: 10; background: var(--bg-dim);
            padding: var(--safe-top) var(--safe-right) var(--safe-bottom) var(--safe-left);
        }

        .logo-placeholder { 
            width: min(90vw, 650px); 
            margin-bottom: 30px; 
            filter: drop-shadow(0 0 20px #ffcc00);
            animation: float 3s ease-in-out infinite;
        }

        @keyframes float {
            0%, 100% { transform: translateY(0); }
            50% { transform: translateY(-15px); }
        }

        .btn {
            padding: 16px 56px; font-size: clamp(1.1rem, 3vw, 2rem);
            cursor: pointer; background: linear-gradient(145deg, #d2691e, #8b4513);
            color: #fff; border: 4px solid #ffcc00; border-radius: 50px;
            box-shadow: 0 10px 20px rgba(0,0,0,0.5);
            transition: 0.2s; font-weight: 900; letter-spacing: 5px; text-transform: uppercase;
        }

        .btn:active { transform: scale(0.95) translateY(5px); }
        #lose-screen { display: none; z-index: 20; }
        .score-display { color: var(--gold); font-size: clamp(1rem, 3.2vw, 1.8rem); margin: 6px 0; font-weight: bold; }

        /* Leaderboard styles */
        #leaderboard {
            background: rgba(0,0,0,0.8);
            border: 3px solid var(--gold);
            border-radius: 15px;
            padding: 15px 25px;
            margin-top: 20px;
            min-width: 280px;
            max-height: 250px;
            overflow-y: auto;
        }
        #leaderboard h3 {
            color: var(--gold);
            margin: 0 0 10px 0;
            text-align: center;
            font-size: 1.2rem;
            text-transform: uppercase;
            letter-spacing: 3px;
        }
        .lb-entry {
            display: flex;
            justify-content: space-between;
            padding: 8px 0;
            border-bottom: 1px solid rgba(255,204,0,0.3);
            color: #fff;
            font-size: 1rem;
        }
        .lb-entry:last-child { border-bottom: none; }
        .lb-rank { color: var(--gold); font-weight: bold; width: 30px; }
        .lb-name { flex: 1; margin: 0 10px; }
        .lb-score { color: var(--gold); font-weight: bold; }

        /* Name input modal */
        #name-modal {
            display: none;
            position: fixed;
            top: 0; left: 0;
            width: 100%; height: 100%;
            background: rgba(0,0,0,0.9);
            z-index: 30;
            flex-direction: column;
            align-items: center;
            justify-content: center;
        }
        #name-modal input {
            padding: 15px 25px;
            font-size: 1.5rem;
            border: 3px solid var(--gold);
            border-radius: 10px;
            background: #111;
            color: #fff;
            text-align: center;
            margin: 20px 0;
            width: 250px;
            outline: none;
        }
        #name-modal input:focus { box-shadow: 0 0 15px var(--gold); }

        #leaderboard-lose {
            background: rgba(0,0,0,0.8);
            border: 3px solid var(--gold);
            border-radius: 15px;
            padding: 15px 25px;
            margin-top: 20px;
            min-width: 280px;
            max-height: 200px;
            overflow-y: auto;
        }
        #leaderboard-lose h3 {
            color: var(--gold);
            margin: 0 0 10px 0;
            text-align: center;
            font-size: 1.2rem;
            text-transform: uppercase;
            letter-spacing: 3px;
        }
    </style>
</head>
<body>

    <div id="ui-layer">
        <img src="assets/logo.png?v=2" alt="LUBENGIO NINJA" class="logo-placeholder" onerror="this.style.display='none'">
        <p class="score-display" id="menu-highscore">BEST: 0</p>
        <button class="btn" onclick="startGame()">START</button>
        <div id="leaderboard">
            <h3>Top Ninjas</h3>
            <div id="lb-list">Loading...</div>
        </div>
    </div>

    <div id="name-modal">
        <h1 style="color: #ff0000; font-size: clamp(2.5rem, 8vw, 4rem); margin: 0; text-shadow: 0 0 30px #ff0000;">ELIMINATED</h1>
        <p id="modal-score" class="score-display"></p>
        <p style="color: #fff; margin: 10px 0;">Enter your name for the leaderboard:</p>
        <input type="text" id="player-name" maxlength="15" placeholder="Your name" onkeydown="if(event.key==='Enter')submitScore()">
        <button class="btn" onclick="submitScore()">SUBMIT</button>
        <button class="btn" style="margin-top: 10px; background: #333;" onclick="skipSubmit()">SKIP</button>
    </div>

    <div id="lose-screen">
        <h1 style="color: #ff0000; font-size: clamp(3rem, 10vw, 5rem); margin: 0; text-shadow: 0 0 30px #ff0000;">ELIMINATED</h1>
        <p id="display-score" class="score-display"></p>
        <button class="btn" onclick="location.reload()" style="margin-top: 20px;">RETRY</button>
        <div id="leaderboard-lose">
            <h3>Top Ninjas</h3>
            <div id="lb-list-lose">Loading...</div>
        </div>
    </div>

<script>
const config = {
    type: Phaser.AUTO,
    width: window.innerWidth,
    height: window.innerHeight,
    scale: { mode: Phaser.Scale.RESIZE, autoCenter: Phaser.Scale.CENTER_BOTH },
    physics: { default: 'arcade', arcade: { gravity: { y: 900 } } },
    scene: { preload: preload, create: create, update: update }
};

let game = new Phaser.Game(config);
let score = 0, lives = 3, level = 1, gameStarted = false, isGameOver = false;
let items, lifeIcons = [], particles, spawnTimer, slicePoints = [];

let highScore = localStorage.getItem('lubengio_best') || 0;
document.getElementById('menu-highscore').innerText = "BEST: " + highScore;

function preload() {
    this.load.image('background', 'assets/survivor_bg.jpg');
    this.load.image('life_img', 'assets/life.png');
    this.load.image('belvedere', 'assets/belvedere.png');
    this.load.image('books', 'assets/books.png');
    this.load.image('chains', 'assets/chains.png');
    this.load.image('coconuts', 'assets/coconuts.png');
    this.load.image('alexandros', 'assets/alexandros.png');
    this.load.image('bomb', 'assets/dont_do_dis.png');
    this.load.image('spark', 'assets/spark.png');
    
    this.load.audio('trap_loop', 'assets/background_trap.mp3');
    this.load.audio('do_dis', 'assets/do_dis.wav');
    this.load.audio('nootropia', 'assets/nootropia.wav');
    this.load.audio('bro', 'assets/bro.wav');
    this.load.audio('alex_snd', 'assets/alexandros.wav');
    this.load.audio('read_snd', 'assets/read.wav');
    this.load.audio('wrong', 'assets/wrong.wav');
    this.load.audio('lose_sound', 'assets/lose_sound.wav');
}

function create() {
    let bg = this.add.image(this.scale.width/2, this.scale.height/2, 'background');
    let scale = Math.max(this.scale.width / bg.width, this.scale.height / bg.height);
    bg.setScale(scale).setScrollFactor(0);

    particles = this.add.particles(0, 0, 'spark', {
        speed: { min: -200, max: 200 }, scale: { start: 0.4, end: 0 }, lifespan: 400, emitting: false
    });

    items = this.physics.add.group();
    this.uiContainer = this.add.container(20, 110);
    this.scoreLabel = this.add.text(0, 0, 'SCORE: 0', { fontSize: '36px', fill: '#ffcc00', fontStyle: 'bold', stroke: '#000', strokeThickness: 6 });
    this.levelLabel = this.add.text(0, 45, 'LEVEL: 1', { fontSize: '24px', fill: '#fff', fontStyle: 'bold', stroke: '#000', strokeThickness: 4 });
    this.uiContainer.add([this.scoreLabel, this.levelLabel]);

    for(let i=0; i<3; i++) {
        let icon = this.add.image(window.innerWidth - 60 - (i * 70), 55, 'life_img').setDisplaySize(60, 60);
        lifeIcons.push(icon);
    }

    this.trailGraphic = this.add.graphics();
    this.input.keyboard.on('keydown-R', () => {
        // Don't reload if typing in input
        if (document.activeElement.tagName === 'INPUT') return;
        if (isGameOver && document.getElementById('name-modal').style.display === 'none') {
            location.reload();
        }
    });
}

function startGame() {
    document.getElementById('ui-layer').style.display = 'none';
    gameStarted = true;
    if (game.scene.scenes[0].cache.audio.exists('trap_loop')) {
        game.scene.scenes[0].sound.play('trap_loop', { loop: true, volume: 0.4 });
    }
    updateSpawnTimer(1100);
}

function updateSpawnTimer(delay) {
    if (spawnTimer) spawnTimer.remove();
    spawnTimer = game.scene.scenes[0].time.addEvent({
        delay: delay,
        callback: () => { if(!isGameOver) spawnItem(game.scene.scenes[0]) },
        loop: true
    });
}

function spawnItem(scene) {
    const keys = ['belvedere', 'books', 'chains', 'coconuts', 'alexandros', 'bomb'];
    const key = Phaser.Utils.Array.GetRandom(keys);
    let item = items.create(Phaser.Math.Between(100, scene.scale.width - 100), scene.scale.height + 60, key);
    item.setDisplaySize(115, 115);
    item.setVelocityY(Phaser.Math.Between(-950 - (level * 25), -1250 - (level * 25)));
    item.setVelocityX(Phaser.Math.Between(-150, 150));
    item.setAngularVelocity(Phaser.Math.Between(-200, 200));
}

function update() {
    if (!gameStarted || isGameOver) return;
    let pointer = this.input.activePointer;
    if (pointer.isDown) {
        slicePoints.push({ x: pointer.x, y: pointer.y });
        if (slicePoints.length > 8) slicePoints.shift();
        this.trailGraphic.clear().lineStyle(6, 0xffffff, 1).beginPath();
        slicePoints.forEach((p, i) => { i === 0 ? this.trailGraphic.moveTo(p.x, p.y) : this.trailGraphic.lineTo(p.x, p.y); });
        this.trailGraphic.strokePath();

        items.getChildren().forEach(item => {
            if (Phaser.Geom.Intersects.LineToRectangle(new Phaser.Geom.Line(pointer.prevPosition.x, pointer.prevPosition.y, pointer.x, pointer.y), item.getBounds())) {
                handleHit(item, this);
            }
        });
    } else { slicePoints = []; this.trailGraphic.clear(); }
}

function handleHit(item, scene) {
    particles.emitParticleAt(item.x, item.y, 15);
    const itemKey = item.texture.key;

    if (itemKey === 'bomb') {
        if (scene.cache.audio.exists('wrong')) scene.sound.play('wrong');
        lives--;
        if(lifeIcons[lives]) scene.tweens.add({ targets: lifeIcons[lives], scale: 1.5, alpha: 0.2, duration: 200 });
        scene.cameras.main.shake(300, 0.03);
        if (lives <= 0) endGame(scene);
    } else {
        if (itemKey === 'alexandros' && scene.cache.audio.exists('alex_snd')) {
            scene.sound.play('alex_snd');
        } else if (itemKey === 'books' && scene.cache.audio.exists('read_snd')) {
            scene.sound.play('read_snd');
        } else {
            const randomSounds = ['do_dis', 'nootropia', 'bro'];
            const chosen = Phaser.Utils.Array.GetRandom(randomSounds);
            if (scene.cache.audio.exists(chosen)) scene.sound.play(chosen);
        }
        
        score += 10;
        if (score % 100 === 0) {
            level++;
            updateSpawnTimer(Math.max(350, 1100 - (level * 60)));
            scene.cameras.main.flash(400, 255, 204, 0, 0.4);
        }
        scene.scoreLabel.setText(`SCORE: ${score}`);
        scene.levelLabel.setText(`LEVEL: ${level}`);
    }
    item.destroy();
}

function endGame(scene) {
    isGameOver = true; game.sound.stopAll();
    if (score > highScore) localStorage.setItem('lubengio_best', score);
    if (scene.cache.audio.exists('lose_sound')) scene.sound.play('lose_sound');

    // Show name modal instead of lose screen
    document.getElementById('modal-score').innerText = "FINAL SCORE: " + score;
    document.getElementById('name-modal').style.display = 'flex';
    document.getElementById('player-name').focus();
}

// Leaderboard functions
let cachedScores = [];
let lowestTopScore = 0;

function loadLeaderboard() {
    db.ref('scores').orderByChild('score').limitToLast(50).on('value', (snapshot) => {
        const data = snapshot.val();
        const lbList = document.getElementById('lb-list');
        const lbListLose = document.getElementById('lb-list-lose');

        if (!data) {
            cachedScores = [];
            lowestTopScore = 0;
            const emptyMsg = '<div style="color:#888;text-align:center;">No scores yet!</div>';
            lbList.innerHTML = emptyMsg;
            lbListLose.innerHTML = emptyMsg;
            return;
        }

        cachedScores = Object.entries(data).map(([key, val]) => ({ key, ...val }));
        cachedScores.sort((a, b) => b.score - a.score);
        lowestTopScore = cachedScores.length >= 50 ? cachedScores[49].score : 0;

        const html = cachedScores.map((entry, i) => `
            <div class="lb-entry">
                <span class="lb-rank">#${i + 1}</span>
                <span class="lb-name">${escapeHtml(entry.username)}</span>
                <span class="lb-score">${entry.score}</span>
            </div>
        `).join('');

        lbList.innerHTML = html;
        lbListLose.innerHTML = html;
    }, (error) => {
        console.error('Leaderboard error:', error);
        const errorMsg = '<div style="color:#888;text-align:center;">Failed to load</div>';
        document.getElementById('lb-list').innerHTML = errorMsg;
        document.getElementById('lb-list-lose').innerHTML = errorMsg;
    });
}

function isTop50Score(playerScore) {
    return cachedScores.length < 50 || playerScore > lowestTopScore;
}

function submitScore() {
    const nameInput = document.getElementById('player-name');
    const username = nameInput.value.trim() || 'Anonymous';

    // Only write if it's a top 50 score
    if (!isTop50Score(score)) {
        showLoseScreen();
        return;
    }

    // Generate unique ID for write-once rule
    const scoreId = Date.now() + '_' + Math.random().toString(36).substr(2, 9);

    db.ref('scores/' + scoreId).set({
        username: username.substring(0, 19),
        score: score
    }).then(() => {
        // If we now have more than 50, delete the lowest
        if (cachedScores.length >= 50) {
            const lowestKey = cachedScores[cachedScores.length - 1].key;
            db.ref('scores/' + lowestKey).remove();
        }
        showLoseScreen();
    }).catch((err) => {
        console.error('Failed to submit score:', err);
        showLoseScreen();
    });
}

function skipSubmit() {
    showLoseScreen();
}

function showLoseScreen() {
    document.getElementById('name-modal').style.display = 'none';
    document.getElementById('display-score').innerText = "FINAL SCORE: " + score;
    document.getElementById('lose-screen').style.display = 'flex';
}

function escapeHtml(text) {
    const div = document.createElement('div');
    div.textContent = text;
    return div.innerHTML;
}

// Load leaderboard on page load
loadLeaderboard();
</script>
</body>
</html>